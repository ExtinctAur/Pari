<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  let bubbles = [];
  let score = 0;
  let gameOver = false;
  let spawnInterval = 1000; // faster spawns
  let bubbleSpeed = 2.5;     // starting faster
  let difficultyRamp = 0;

  const currentUser = localStorage.getItem("loggedInUser") || "Pari";
  let sharvilScore = parseInt(localStorage.getItem("highscore_Sharvil")) || 0;
  let pariScore = parseInt(localStorage.getItem("highscore_Pari")) || 0;

  function updateScoreboard(player, playerScore, opponentScore) {
    document.getElementById("current-player").textContent = player;
    document.getElementById("your-highscore").textContent = playerScore;
    document.getElementById("opponent-name").textContent = player === "Pari" ? "Sharvil" : "Pari";
    document.getElementById("opponent-highscore").textContent = opponentScore;
  }

  if (currentUser === "Pari") {
    updateScoreboard("Pari", pariScore, sharvilScore);
  } else {
    updateScoreboard("Sharvil", sharvilScore, pariScore);
  }

  function spawnBubble() {
    const howMany = 2 + Math.floor(Math.random() * 2); // spawn 2-3 at once
    for (let i = 0; i < howMany; i++) {
      const radius = 15 + Math.random() * 15;
      const x = radius + Math.random() * (canvas.width - 2 * radius);
      const y = canvas.height + radius;
      const color = `hsl(${Math.random() * 360}, 80%, 70%)`;
      bubbles.push({ x, y, radius, color });
    }
  }

  function drawBubbles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let bubble of bubbles) {
      ctx.beginPath();
      ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
      ctx.fillStyle = bubble.color;
      ctx.fill();
      ctx.closePath();
    }
  }

  function updateBubbles() {
    for (let bubble of bubbles) {
      bubble.y -= bubbleSpeed;
      if (bubble.y + bubble.radius < 0) {
        endGame();
      }
    }
  }

  function handleClick(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    for (let i = 0; i < bubbles.length; i++) {
      const b = bubbles[i];
      const dist = Math.hypot(x - b.x, y - b.y);
      if (dist < b.radius) {
        bubbles.splice(i, 1);
        score++;
        bubbleSpeed += 0.05; // increases speed faster
        document.getElementById("live-score").textContent = score;
        return;
      }
    }
  }

  function endGame() {
    gameOver = true;
    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#fff';
    ctx.font = '32px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`Game Over! Score: ${score}`, canvas.width / 2, canvas.height / 2);

    if (currentUser === "Pari" && score > sharvilScore) {
      let tokens = parseInt(localStorage.getItem("pariTokens")) || 0;
      tokens++;
      localStorage.setItem("pariTokens", tokens);
      alert("You beat Sharvil's score! You earned 1 wish token!");
    }

    if (currentUser === "Pari" && score > pariScore) {
      localStorage.setItem("highscore_Pari", score);
      updateScoreboard("Pari", score, sharvilScore);
    }
    if (currentUser === "Sharvil" && score > sharvilScore) {
      localStorage.setItem("highscore_Sharvil", score);
      updateScoreboard("Sharvil", score, pariScore);
    }
  }

  canvas.addEventListener('click', handleClick);

  function gameLoop() {
    if (!gameOver) {
      updateBubbles();
      drawBubbles();
      requestAnimationFrame(gameLoop);
    }
  }

  setInterval(() => {
    if (!gameOver) {
      spawnBubble();
    }
  }, spawnInterval);

  // Difficulty ramping every 5 seconds
  setInterval(() => {
    if (!gameOver) {
      bubbleSpeed += 0.2;
      if (spawnInterval > 400) {
        spawnInterval -= 50;
      }
    }
  }, 5000);

  gameLoop();
</script>
